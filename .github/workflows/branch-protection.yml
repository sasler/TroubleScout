name: Branch Protection

on:
  pull_request:
    branches: [ main ]

jobs:
  validate:
    name: Validate PR
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Validate branch naming
      run: |
        BRANCH_NAME="${{ github.head_ref }}"
        echo "Branch name: $BRANCH_NAME"
        
        # Allow specific branch name patterns
        if [[ "$BRANCH_NAME" =~ ^(feature|fix|hotfix|chore|docs|test|refactor|perf|ci|build|revert|release)/[a-z0-9.-]+$ ]] || \
           [[ "$BRANCH_NAME" =~ ^(dependabot|renovate|copilot)/ ]]; then
          echo "✅ Branch name follows convention"
        else
          echo "❌ Branch name must follow pattern: {type}/{description}"
          echo "   Valid types: feature, fix, hotfix, chore, docs, test, refactor, perf, ci, build, revert, release"
          echo "   Description should be lowercase with hyphens"
          echo "   Example: feature/add-new-tool or fix/memory-leak"
          exit 1
        fi

    - name: Validate commit messages
      run: |
        echo "Checking commit messages..."
        
        # Get commits and save to a file for Python to read
        git log origin/main..${{ github.sha }} --pretty=format:"%s" --no-merges > /tmp/commits.txt
        
        # Use Python for reliable emoji detection
        python3 << 'PYTHON_EOF'
        import sys
        import re
        
        with open('/tmp/commits.txt', 'r', encoding='utf-8') as f:
            commits = [line.strip() for line in f if line.strip()]
        
        invalid_commits = []
        
        for commit in commits:
            # Check conventional commit format
            if re.match(r'^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?:\s.+', commit):
                continue
            
            # Check for emoji at start (Unicode emoji ranges)
            # This covers most common emojis including the ones used in this repo
            if re.match(r'^[\U0001F300-\U0001F9FF\u2600-\u26FF\u2700-\u27BF]\s.+', commit):
                continue
            
            # Allow simple plan/work tracking commits (common in automated workflows)
            if re.match(r'^(Initial plan|Work in progress|WIP|Checkpoint)$', commit, re.IGNORECASE):
                continue
            
            # Allow automated update commits (common with bots and automated tools)
            if re.match(r'^Update\s.+', commit):
                continue
            
            invalid_commits.append(commit)
        
        if invalid_commits:
            print("❌ The following commits do not follow the required format:")
            for commit in invalid_commits:
                print(f"  {commit}")
            print()
            print("Commit messages must either:")
            print("1. Start with an emoji (e.g., ✨ Add new feature)")
            print("2. Follow Conventional Commits (e.g., feat: add new feature)")
            print("3. Be a simple plan commit (e.g., Initial plan, WIP)")
            print("4. Be an automated update (e.g., Update README.md)")
            sys.exit(1)
        
        print("✅ All commit messages follow the required format")
        PYTHON_EOF

    - name: Check for required files
      run: |
        echo "Checking for required files..."
        
        REQUIRED_FILES=(
          "README.md"
          ".github/workflows/build.yml"
          ".github/workflows/tests.yml"
          ".gitignore"
        )
        
        MISSING_FILES=()
        for file in "${REQUIRED_FILES[@]}"; do
          if [ ! -f "$file" ]; then
            MISSING_FILES+=("$file")
          fi
        done
        
        if [ ${#MISSING_FILES[@]} -gt 0 ]; then
          echo "❌ Missing required files:"
          printf '%s\n' "${MISSING_FILES[@]}"
          exit 1
        fi
        
        echo "✅ All required files present"

    - name: Verify PR targets main branch
      run: |
        if [ "${{ github.base_ref }}" != "main" ]; then
          echo "❌ PRs must target the main branch"
          exit 1
        fi
        echo "✅ PR correctly targets main branch"

  # This job ensures that required checks are defined
  required-checks-status:
    name: Required Checks Summary
    runs-on: ubuntu-latest
    needs: [validate]
    if: always()
    steps:
    - name: Check required jobs
      run: |
        if [ "${{ needs.validate.result }}" != "success" ]; then
          echo "❌ Required validation checks failed"
          exit 1
        fi
        echo "✅ All required checks passed"
